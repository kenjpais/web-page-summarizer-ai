name: "Issue Management"

on:
  issues:
    types: [opened, reopened, edited, labeled]
  pull_request:
    types: [opened, reopened, edited]

permissions:
  issues: write
  pull-requests: write
  models: read
  contents: read

jobs:
  initial-triage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Quality Check
        id: quality
        uses: actions/ai-inference@v1
        with:
          prompt: |
            Analyze this GitHub ${{ github.event_name == 'issues' && 'issue' || 'pull request' }}:
            
            Title: ${{ github.event.issue.title || github.event.pull_request.title }}
            Body: ${{ github.event.issue.body || github.event.pull_request.body }}
            
            Determine:
            1. Issue type (bug, feature, security, etc.)
            2. Completeness of information
            3. Quality and clarity
            4. Priority level
            
            Respond with a JSON object:
            {
              "type": "bug|feature|security|documentation|question",
              "status": "complete|needs-info|invalid",
              "priority": "high|medium|low",
              "missing_info": [],
              "recommendation": "string"
            }
          model: github/gpt-35-turbo

      - name: Apply Initial Labels
        uses: actions/github-script@v7
        with:
          script: |
            try {
              let responseText = '${{ steps.quality.outputs.response }}';
              // Clean up the response text
              responseText = responseText.replace(/[\n\r]/g, '').trim();
              const response = JSON.parse(responseText);
              const number = ${{ github.event.issue.number || github.event.pull_request.number }};
              
              const labels = [];
              
              // Add type label if valid
              if (response.type && ['bug', 'feature', 'security', 'documentation', 'question'].includes(response.type)) {
                labels.push(`kind/${response.type}`);
              }
              
              // Add status label if valid
              if (response.status && ['complete', 'needs-info', 'invalid'].includes(response.status)) {
                labels.push(`status/${response.status}`);
              }
              
              // Add priority label if valid
              if (response.priority && ['high', 'medium', 'low'].includes(response.priority)) {
                labels.push(`priority/${response.priority}`);
              }
              
              if (labels.length > 0) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: number,
                  labels: labels
                });
              }
              
              if (response.status === 'needs-info' && response.missing_info && response.missing_info.length > 0) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: number,
                  body: `Please provide the following additional information:\n\n${response.missing_info.map(i => `- ${i}`).join('\n')}\n\n${response.recommendation || ''}`
                });
              }
            } catch (error) {
              console.error('Error processing AI response:', error);
              // Add a fallback label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: number,
                labels: ['status/needs-triage']
              });
            }

  ai-assessment:
    if: github.event.label.name == 'request ai review'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run AI Assessment
        id: ai-assessment
        uses: actions/ai-inference@v1
        with:
          model: github/gpt-35-turbo
          prompt: |
            Review this GitHub issue for technical assessment:
            
            Title: ${{ github.event.issue.title }}
            Body: ${{ github.event.issue.body }}
            
            Provide a detailed technical assessment of:
            1. Issue complexity and scope
            2. Potential impact and risks
            3. Implementation suggestions
            4. Required expertise level
            
            Format your response in markdown with clear sections.

      - name: Process Results
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const response = '${{ steps.ai-assessment.outputs.response }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: response
            });