name: "Issue Management"

on:
  issues:
    types: [opened, reopened, edited, labeled]
  pull_request:
    types: [opened, reopened, edited]

permissions:
  issues: write
  pull-requests: write
  models: read
  contents: read

jobs:
  summarize-to-slack:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - name: Summarize issue
        id: summarize-issue
        uses: actions/ai-inference@v1
        with:
          model: gpt-4o-mini
          prompt: |
            Summarize this GitHub issue:
            
            Title: ${{ github.event.issue.title }}
            Body: ${{ github.event.issue.body }}
            
            Provide a detailed technical assessment of:
            1. Issue complexity and scope
            2. Potential impact and risks
            3. Implementation suggestions
            4. Required expertise level
            
            Format your response in markdown with clear sections.
      - name: Determine Priority Color
        id: priority-color
        run: |
          if [[ "${{ github.event.issue.labels.*.name }}" == *"priority/critical"* ]]; then
            echo "color=danger" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.issue.labels.*.name }}" == *"priority/high"* ]]; then
            echo "color=warning" >> $GITHUB_OUTPUT
          else
            echo "color=good" >> $GITHUB_OUTPUT
          fi

      - name: Format Labels
        id: format-labels
        run: |
          labels="${{ github.event.issue.labels.*.name }}"
          if [ -n "$labels" ] && [ "$labels" != "null" ]; then
            # Convert array format to comma-separated string
            formatted_labels=$(echo "$labels" | tr -d '[]' | tr ',' '\n' | tr -d ' ' | grep -v '^$' | tr '\n' ',' | sed 's/,$//')
            echo "labels=$formatted_labels" >> $GITHUB_OUTPUT
          else
            echo "labels=None" >> $GITHUB_OUTPUT
          fi

      - name: Prepare Slack Data
        id: slack-data
        run: |
          # Safely escape JSON values
          title=$(echo '${{ github.event.issue.title }}' | sed 's/"/\\"/g' | sed 's/\\/\\\\/g')
          summary=$(echo '${{ steps.summarize-issue.outputs.response }}' | sed 's/"/\\"/g' | sed 's/\\/\\\\/g' | head -c 2000)
          labels=$(echo '${{ steps.format-labels.outputs.labels }}' | sed 's/"/\\"/g')
          
          echo "title=$title" >> $GITHUB_OUTPUT
          echo "summary=$summary" >> $GITHUB_OUTPUT
          echo "labels=$labels" >> $GITHUB_OUTPUT

      - name: Push to Slack
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "channel": "${{ secrets.SLACK_CHANNEL || '#github-issues' }}",
              "text": "ðŸš¨ New Issue Created",
              "attachments": [
                {
                  "color": "${{ steps.priority-color.outputs.color }}",
                  "title": "Issue #${{ github.event.issue.number }}: ${{ steps.slack-data.outputs.title }}",
                  "title_link": "${{ github.event.issue.html_url }}",
                  "text": "${{ steps.slack-data.outputs.summary }}",
                  "fields": [
                    {
                      "title": "Repository",
                      "value": "${{ github.repository }}",
                      "short": true
                    },
                    {
                      "title": "Author",
                      "value": "${{ github.event.issue.user.login }}",
                      "short": true
                    },
                    {
                      "title": "Labels",
                      "value": "${{ steps.slack-data.outputs.labels }}",
                      "short": false
                    }
                  ],
                  "footer": "GitHub Issue Management Bot",
                  "ts": "${{ github.event.issue.created_at }}"
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}